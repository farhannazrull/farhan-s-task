<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farhan Task Dashboard</title><!-- PWA Meta Tags -->
  <meta name="theme-color" content="#2383e2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Farhan Tasks">
  <meta name="description" content="Personal task management dashboard for Farhan"><!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZhcmhhbiBUYXNrIERhc2hib2FyZCIsCiAgInNob3J0X25hbWUiOiAiRmFyaGFuIFRhc2tzIiwKICAiZGVzY3JpcHRpb24iOiAiUGVyc29uYWwgdGFzayBtYW5hZ2VtZW50IGRhc2hib2FyZCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMyMzgzZTIiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lqNDhjbVZqZENCM2FXUjBhRDBpTVRJd0lpQm9aV2xuYUhROUlqRXlNQ0lpSUdacGJHdzlJaU15TXpnek9ESTJJaUJ5ZUQwaU1UQWlMejQ4ZEdWNGRDQjRQU0kyTUNJZ2VUMGlOVEFpSUdacGJHdzlJaU5tWm1abVptWWlJR1p2Ym5RdGMybDZaVDBpTkRBaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQajQ4TDNSbGVIUStQQzl6ZG1jKyIsCiAgICAgICJzaXplcyI6ICIxMjB4MTIwIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l5TlRZaUlHaGxhV2RvZEQwaU1qVTJJajQ4Y21WamRDQjNhV1IwYUQwaU1qVTJJaUJvWldsbmFIUTlJakkxTmlJZ1ptbHNiRDBpSXpJek9ETmxNaUlnY25nOUlqSXdJaTgrUEhSbGVIUWdlRDBpTVRJNElpQjVQU0l4TWpnaUlHWnBiR3c5SWlObVptWm1abVlpSUdadmJuUXRjMmw2WlQwaU9EQWlJSFJsZUhRdFlXNWphRzl5UFNKdGFXUmtiR1VpUGo0OEwzUmxlSFErUEM5emRtYysiLAogICAgICAic2l6ZXMiOiAiMjU2eDI1NiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9"><!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgZmlsbD0iIzIzODNlMiIgcng9IjMwIi8+PHRleHQgeD0iOTAiIHk9IjEwNSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1zaXplPSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+üìã</dGV4dD48L3N2Zz4=">
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .notion-bg {
            background: #ffffff;
        }
        
        .notion-sidebar {
            background: #f7f6f3;
            border-right: 1px solid #e9e9e7;
        }
        
        .notion-card {
            background: #ffffff;
            border: 1px solid #e9e9e7;
            transition: all 0.2s ease;
        }
        
        .notion-card:hover {
            background: #f7f6f3;
            border-color: #d3d1cb;
        }
        
        .notion-input {
            background: #ffffff;
            border: 1px solid #e9e9e7;
            color: #37352f;
        }
        
        .notion-input:focus {
            border-color: #2383e2;
            box-shadow: 0 0 0 1px #2383e2;
        }
        
        .notion-button {
            background: #2383e2;
            color: white;
            border: none;
            font-weight: 500;
        }
        
        .notion-button:hover {
            background: #1a6bb8;
        }
        
        .notion-text {
            color: #37352f;
        }
        
        .notion-text-secondary {
            color: #787774;
        }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #8b5cf6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .custom-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .custom-checkbox:checked {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        .custom-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: -1px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .priority-high { background: #fef2f2; color: #dc2626; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #f0fdf4; color: #16a34a; }
        
        .status-todo { background: #f3f4f6; color: #6b7280; }
        .status-progress { background: #dbeafe; color: #2563eb; }
        .status-done { background: #f0fdf4; color: #16a34a; }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
        }

        .status-connecting { background: #fbbf24; color: #92400e; }
        .status-connected { background: #10b981; color: white; }
        .status-error { background: #ef4444; color: white; }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full notion-bg font-sans"><!-- Connection Status Indicator -->
  <div id="connection-status" class="connection-status status-connecting hidden">
   üîÑ Connecting to Canva Sheet...
  </div>
  <main class="min-h-full">
   <div class="max-w-7xl mx-auto"><!-- Main Container -->
    <div class="notion-bg p-6"><!-- Header -->
     <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
      <div class="flex items-center gap-3"><span class="text-2xl">üìã</span>
       <h1 class="text-3xl font-bold notion-text">Farhan's Tasks</h1>
      </div>
      <div class="flex items-center gap-3"><span class="text-sm notion-text-secondary">Total: <span id="task-count">0</span> tasks</span> <button id="notification-btn" class="p-2 hover:bg-gray-100 rounded transition-colors"> <span class="text-lg">üîî</span> </button>
      </div>
     </div><!-- Progress Section -->
     <div class="mb-6">
      <div class="flex items-center justify-between mb-3">
       <h3 class="text-lg font-semibold notion-text">Progress</h3><span id="progress-percentage" class="text-sm font-medium notion-text-secondary">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded h-2">
       <div id="progress-bar" class="progress-bar bg-blue-500 h-2 rounded" style="width: 0%"></div>
      </div>
     </div><!-- Input Section -->
     <div class="mb-6"><!-- Search Bar -->
      <div class="mb-4"><input type="text" id="search-input" placeholder="üîç Search tasks..." class="w-full px-4 py-3 notion-input rounded-lg focus:outline-none text-base">
      </div><!-- Add Task Form -->
      <form id="task-form" class="space-y-3">
       <div class="flex gap-3"><input type="text" id="task-title" placeholder="‚úçÔ∏è Add a task..." class="flex-1 px-4 py-3 notion-input rounded-lg focus:outline-none text-base" required> <button type="submit" id="add-button" class="px-6 py-3 notion-button rounded-lg transition-colors flex items-center gap-2"> <span>Add</span>
         <div id="add-loading" class="loading-spinner hidden"></div></button>
       </div><!-- Properties Row -->
       <div class="grid grid-cols-2 md:grid-cols-4 gap-3"><select id="task-category" class="px-3 py-2 notion-input rounded text-sm focus:outline-none"> <option value="">üìÅ Category</option> <option value="Work">üíº Work</option> <option value="Personal">üè† Personal</option> <option value="Study">üìö Study</option> <option value="Health">üí™ Health</option> </select> <select id="task-priority" class="px-3 py-2 notion-input rounded text-sm focus:outline-none"> <option value="">‚ö° Priority</option> <option value="High">üî¥ High</option> <option value="Medium">üü° Medium</option> <option value="Low">üü¢ Low</option> </select> <select id="task-status" class="px-3 py-2 notion-input rounded text-sm focus:outline-none"> <option value="">üìã Status</option> <option value="Todo">üìù To Do</option> <option value="Progress">‚è≥ In Progress</option> <option value="Done">‚úÖ Done</option> </select> <input type="date" id="task-deadline" class="px-3 py-2 notion-input rounded text-sm focus:outline-none" title="Task deadline">
       </div>
      </form>
     </div><!-- Tasks List -->
     <div id="tasks-container" class="space-y-4"><!-- Tasks will be rendered here -->
     </div><!-- Empty State -->
     <div id="empty-state" class="text-center py-16 notion-text-secondary hidden">
      <div class="text-4xl mb-3">
       üìù
      </div>
      <h3 class="text-lg font-medium mb-2 notion-text">No tasks yet</h3>
      <p class="text-sm">Add your first task to get started!</p>
     </div>
    </div>
   </div>
  </main>
  <script>
        // Connection Status Management
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status status-${status}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // Cloud Data Management with Canva Sheet
        class TaskManager {
            constructor() {
                this.tasks = [];
                this.filteredTasks = [];
                this.expandedTasks = new Set();
                this.autoSort = false;
                this.isInitialized = false;
            }

            async initialize() {
                if (this.isInitialized) return;
                
                updateConnectionStatus('connecting', 'üîÑ Connecting to Canva Sheet...');
                
                const dataHandler = {
                    onDataChanged: (data) => {
                        console.log('Data received from Canva Sheet:', data.length, 'tasks');
                        this.tasks = data.map(task => ({
                            ...task,
                            subtasks: task.subtasks ? JSON.parse(task.subtasks) : []
                        }));
                        this.updateUI();
                    }
                };

                if (window.dataSdk) {
                    try {
                        const result = await window.dataSdk.init(dataHandler);
                        if (result.isOk) {
                            this.isInitialized = true;
                            updateConnectionStatus('connected', '‚úÖ Connected to Canva Sheet!');
                            console.log('Successfully connected to Canva Sheet');
                        } else {
                            console.error('Failed to initialize Data SDK:', result.error);
                            updateConnectionStatus('error', '‚ùå Failed to connect to cloud storage');
                        }
                    } catch (error) {
                        console.error('Error initializing Data SDK:', error);
                        updateConnectionStatus('error', '‚ùå Connection error');
                    }
                } else {
                    console.error('Data SDK not available');
                    updateConnectionStatus('error', '‚ùå Data SDK not available');
                }
            }

            async addTask(taskData) {
                if (!this.isInitialized) {
                    showToast('Please wait, connecting to cloud...', 'info');
                    return;
                }

                if (this.tasks.length >= 999) {
                    showToast('Maximum limit of 999 tasks reached. Please delete some tasks first.', 'error');
                    return;
                }

                const newTask = {
                    id: Date.now().toString(),
                    title: taskData.title,
                    category: taskData.category || '',
                    priority: taskData.priority || '',
                    status: taskData.status || 'Todo',
                    deadline: taskData.deadline || '',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    subtasks: JSON.stringify([])
                };

                try {
                    const result = await window.dataSdk.create(newTask);
                    if (result.isOk) {
                        showToast('Task saved to Canva Sheet!', 'success');
                        console.log('Task created successfully');
                    } else {
                        console.error('Failed to create task:', result.error);
                        showToast('Failed to save task', 'error');
                    }
                } catch (error) {
                    console.error('Error creating task:', error);
                    showToast('Failed to save task', 'error');
                }
                return newTask;
            }

            async updateTask(taskId, updates) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    const updatedTask = { 
                        ...task, 
                        ...updates,
                        subtasks: typeof updates.subtasks === 'object' ? JSON.stringify(updates.subtasks) : task.subtasks
                    };
                    
                    try {
                        const result = await window.dataSdk.update(updatedTask);
                        if (result.isOk) {
                            console.log('Task updated successfully');
                            return updatedTask;
                        } else {
                            console.error('Failed to update task:', result.error);
                            showToast('Failed to update task', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating task:', error);
                        showToast('Failed to update task', 'error');
                    }
                }
                return null;
            }

            async deleteTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    try {
                        const result = await window.dataSdk.delete(task);
                        if (result.isOk) {
                            showToast('Task deleted from Canva Sheet!', 'success');
                            console.log('Task deleted successfully');
                            return true;
                        } else {
                            console.error('Failed to delete task:', result.error);
                            showToast('Failed to delete task', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting task:', error);
                        showToast('Failed to delete task', 'error');
                    }
                }
                return false;
            }

            async toggleTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    const updates = {
                        completed: !task.completed,
                        status: !task.completed ? 'Done' : task.status
                    };
                    return await this.updateTask(taskId, updates);
                }
                return null;
            }

            async addSubtask(taskId, subtaskText) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    const newSubtask = {
                        id: Date.now().toString(),
                        text: subtaskText,
                        completed: false
                    };
                    const updatedSubtasks = [...task.subtasks, newSubtask];
                    const result = await this.updateTask(taskId, { subtasks: updatedSubtasks });
                    if (result) {
                        showToast('Subtask saved to Canva Sheet!', 'success');
                        return newSubtask;
                    }
                }
                return null;
            }

            async toggleSubtask(taskId, subtaskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    const subtaskIndex = task.subtasks.findIndex(s => s.id === subtaskId);
                    if (subtaskIndex !== -1) {
                        const updatedSubtasks = [...task.subtasks];
                        updatedSubtasks[subtaskIndex].completed = !updatedSubtasks[subtaskIndex].completed;
                        const result = await this.updateTask(taskId, { subtasks: updatedSubtasks });
                        if (result) {
                            return updatedSubtasks[subtaskIndex];
                        }
                    }
                }
                return null;
            }

            async deleteSubtask(taskId, subtaskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    const updatedSubtasks = task.subtasks.filter(s => s.id !== subtaskId);
                    const result = await this.updateTask(taskId, { subtasks: updatedSubtasks });
                    if (result) {
                        showToast('Subtask deleted from Canva Sheet!', 'success');
                        return true;
                    }
                }
                return false;
            }

            applyFilters(searchTerm = '') {
                this.filteredTasks = this.tasks.filter(task => {
                    return task.title.toLowerCase().includes(searchTerm.toLowerCase());
                });

                if (this.autoSort) {
                    this.filteredTasks.sort((a, b) => {
                        if (!a.deadline && !b.deadline) return 0;
                        if (!a.deadline) return 1;
                        if (!b.deadline) return -1;
                        return new Date(a.deadline) - new Date(b.deadline);
                    });
                }

                this.renderTasks();
            }

            updateUI() {
                this.applyFilters(document.getElementById('search-input').value);
                this.updateProgress();
                this.updateTaskCount();
            }

            updateProgress() {
                const totalTasks = this.tasks.length;
                const completedTasks = this.tasks.filter(task => task.completed).length;
                const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                document.getElementById('progress-percentage').textContent = `${percentage}%`;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
            }

            updateTaskCount() {
                document.getElementById('task-count').textContent = this.tasks.length;
            }

            renderTasks() {
                const container = document.getElementById('tasks-container');
                const emptyState = document.getElementById('empty-state');
                
                if (this.filteredTasks.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                container.innerHTML = this.filteredTasks.map(task => {
                    const isExpanded = this.expandedTasks.has(task.id);
                    
                    return `
                        <div class="notion-card rounded-lg p-4 mb-2">
                            <div class="flex items-start gap-3">
                                <input 
                                    type="checkbox" 
                                    class="custom-checkbox mt-1" 
                                    ${task.completed ? 'checked' : ''}
                                    onchange="taskManager.toggleTask('${task.id}')"
                                >
                                <div class="flex-1">
                                    <h3 class="text-base font-medium notion-text mb-2 ${task.completed ? 'line-through opacity-60' : ''}">${escapeHtml(task.title)}</h3>
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        ${task.deadline ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">üìÖ ${formatDate(task.deadline)}</span>` : ''}
                                        ${task.category ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">${getCategoryIcon(task.category)} ${task.category}</span>` : ''}
                                        ${task.priority ? `<span class="px-2 py-1 priority-${task.priority.toLowerCase()} rounded text-xs font-medium">${getPriorityIcon(task.priority)} ${getPriorityText(task.priority)}</span>` : ''}
                                        ${task.status ? `<span class="px-2 py-1 status-${task.status.toLowerCase()} rounded text-xs font-medium">${getStatusIcon(task.status)} ${getStatusText(task.status)}</span>` : ''}
                                    </div>
                                    ${isExpanded ? `
                                        <div class="mt-3 pl-4 border-l-2 border-gray-200">
                                            <div class="space-y-2 mb-3">
                                                ${task.subtasks.map(subtask => `
                                                    <div class="flex items-center gap-2">
                                                        <input type="checkbox" class="custom-checkbox" ${subtask.completed ? 'checked' : ''} onchange="taskManager.toggleSubtask('${task.id}', '${subtask.id}')">
                                                        <span class="text-sm notion-text ${subtask.completed ? 'line-through opacity-60' : ''}">${escapeHtml(subtask.text)}</span>
                                                        <button onclick="taskManager.deleteSubtask('${task.id}', '${subtask.id}')" class="text-gray-400 hover:text-red-500 text-xs ml-auto">√ó</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div class="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    id="subtask-input-${task.id}" 
                                                    placeholder="Add subtask..." 
                                                    class="flex-1 px-3 py-2 notion-input rounded text-sm focus:outline-none"
                                                    onkeypress="if(event.key==='Enter') { taskManager.addSubtask('${task.id}', this.value); this.value=''; }"
                                                >
                                                <button onclick="addSubtaskFromInput('${task.id}')" class="px-3 py-2 notion-button rounded text-sm transition-colors">Add</button>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="toggleExpand('${task.id}')" class="p-1 hover:bg-gray-100 rounded text-sm text-gray-500 hover:text-gray-700">‚ãØ</button>
                                    <button onclick="editTask('${task.id}')" class="p-1 hover:bg-gray-100 rounded text-sm text-gray-500 hover:text-gray-700">‚úèÔ∏è</button>
                                    <button onclick="taskManager.deleteTask('${task.id}')" class="p-1 hover:bg-gray-100 rounded text-sm text-gray-500 hover:text-red-500">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Initialize Task Manager
        const taskManager = new TaskManager();

        // Helper Functions
        function getCategoryIcon(category) {
            const icons = {
                'Work': 'üíº',
                'Personal': 'üè†', 
                'Study': 'üìö',
                'Health': 'üí™'
            };
            return icons[category] || 'üìÅ';
        }

        function getPriorityIcon(priority) {
            const icons = {
                'High': 'üî¥',
                'Medium': 'üü°',
                'Low': 'üü¢'
            };
            return icons[priority] || '‚ö°';
        }

        function getPriorityText(priority) {
            const texts = {
                'High': 'High',
                'Medium': 'Medium',
                'Low': 'Low'
            };
            return texts[priority] || priority;
        }

        function getStatusIcon(status) {
            const icons = {
                'Todo': 'üìù',
                'Progress': '‚è≥',
                'Done': '‚úÖ'
            };
            return icons[status] || 'üìù';
        }

        function getStatusText(status) {
            const texts = {
                'Todo': 'To Do',
                'Progress': 'In Progress',
                'Done': 'Done'
            };
            return texts[status] || status;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setLoading(loading) {
            const button = document.getElementById('add-button');
            const spinner = document.getElementById('add-loading');
            
            button.disabled = loading;
            
            if (loading) {
                spinner.classList.remove('hidden');
                button.classList.add('opacity-75');
            } else {
                spinner.classList.add('hidden');
                button.classList.remove('opacity-75');
            }
        }

        // UI Event Handlers
        function toggleExpand(taskId) {
            if (taskManager.expandedTasks.has(taskId)) {
                taskManager.expandedTasks.delete(taskId);
            } else {
                taskManager.expandedTasks.add(taskId);
            }
            taskManager.renderTasks();
        }

        async function addSubtaskFromInput(taskId) {
            const input = document.getElementById(`subtask-input-${taskId}`);
            const text = input.value.trim();
            if (text) {
                await taskManager.addSubtask(taskId, text);
                input.value = '';
            }
        }

        async function editTask(taskId) {
            const task = taskManager.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Fill form with task data
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-category').value = task.category || '';
            document.getElementById('task-priority').value = task.priority || '';
            document.getElementById('task-status').value = task.status || 'Todo';
            document.getElementById('task-deadline').value = task.deadline || '';
            
            // Delete the task so user can re-add with changes
            await taskManager.deleteTask(taskId);
            
            showToast('Task loaded for editing. Modify and click Add.', 'info');
        }

        // Event Listeners
        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('task-title').value.trim();
            const category = document.getElementById('task-category').value;
            const priority = document.getElementById('task-priority').value;
            const status = document.getElementById('task-status').value;
            
            // Input validation
            if (!title) {
                showToast('Task title is required!', 'error');
                return;
            }
            
            if (!category) {
                showToast('Category must be selected!', 'error');
                return;
            }
            
            if (!priority) {
                showToast('Priority must be selected!', 'error');
                return;
            }
            
            if (!status) {
                showToast('Status must be selected!', 'error');
                return;
            }
            
            setLoading(true);
            
            try {
                const taskData = {
                    title: title,
                    category: category,
                    priority: priority,
                    status: status,
                    deadline: document.getElementById('task-deadline').value
                };
                
                await taskManager.addTask(taskData);
                
                // Clear form
                document.getElementById('task-title').value = '';
                document.getElementById('task-category').value = '';
                document.getElementById('task-priority').value = '';
                document.getElementById('task-status').value = '';
                document.getElementById('task-deadline').value = '';
            } catch (error) {
                console.error('Error in form submission:', error);
                showToast('Failed to save task', 'error');
            } finally {
                setLoading(false);
            }
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            taskManager.applyFilters(e.target.value);
        });

        document.getElementById('notification-btn').addEventListener('click', () => {
            const upcomingTasks = taskManager.tasks.filter(task => {
                if (!task.deadline || task.completed) return false;
                const deadline = new Date(task.deadline);
                const today = new Date();
                const diffTime = deadline - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 3 && diffDays >= 0;
            });
            
            if (upcomingTasks.length > 0) {
                showToast(`${upcomingTasks.length} tasks due within 3 days!`, 'info');
            } else {
                showToast('No upcoming deadlines!', 'success');
            }
        });

        // Initialize the application
        async function initializeApp() {
            console.log('Initializing Farhan Task Dashboard...');
            console.log('Data SDK available:', !!window.dataSdk);
            
            await taskManager.initialize();
            taskManager.updateUI();
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'farhan-tasks-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('PWA Service Worker registered'))
                    .catch(() => console.log('PWA Service Worker registration failed'));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installBtn = document.createElement('button');
            installBtn.textContent = 'üì± Install as App';
            installBtn.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-600 transition-colors z-50';
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('App installed successfully!', 'success');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                });
            };
            document.body.appendChild(installBtn);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99e46bb71751ca4b',t:'MTc2MzEwMTQxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
